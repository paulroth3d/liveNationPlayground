public class LNE_EventSearch {

    private static final String ARTIST_ID_PLACEHOLDER = '<ARTIST_ID>';
    private static final String REQUEST_TYPE = 'GET';
    private static final String ARTIST_PREFIX = 'art_';
    
    public static LNE_API_EventSearchResp getEvents(String artistId, String parameters) {
        if(String.isBlank(artistId)) {
            return null;    
        }
        
        HttpRequest req = new HttpRequest();
        API_Settings__c apiSettings = API_Settings__c.getInstance();
        String endpoint = apiSettings.LiveNationAPI_Endpoint__c + '/artists/' + ARTIST_ID_PLACEHOLDER + '/events/';    
    
        req.setEndpoint(endpoint.replace(ARTIST_ID_PLACEHOLDER, artistId.replace(ARTIST_PREFIX, '')) + parameters);
        req.setMethod(REQUEST_TYPE);
        
        Http http = new Http();
        
        if(Test.isRunningTest()) {
            return LNE_API_EventSearchResp.parse(getTestResponse());
        }
        
        HTTPResponse res = http.send(req);
        return LNE_API_EventSearchResp.parse(res.getBody());
    }
    
    public static LNE_API_EventSearchResp getEventsByVenue(String artistId, String parameters, String venueId) {
        LNE_API_EventSearchResp response = getEvents(artistId, parameters);
        
        if(response == null || response.data == null) {
            return null;
        }
        
        List<LNE_API_EventSearchResp.Data> filteredData = new List<LNE_API_EventSearchResp.Data>();
        
        for(LNE_API_EventSearchResp.Data apiEvent : response.data) {
            if(apiEvent.venue != null && apiEvent.venue.id == venueId) {
                filteredData.add(apiEvent);
            }
        }
        
        response.data = filteredData;
        
        return response;
    }
    
    public static String getTestResponse() {
        return '{"meta":{"status":200,"message":"OK"},"pagination":{"total":4,"offset":0,"count":4},"data":[{"id":"evt_640760","name":"Big Chief Package 2nd Weekend - N.O. Jazz & Heritage Festival","lat":"29.9841","lng":"-90.081174","start_time":"2017-05-05T00:00:00Z","end_time":"2017-05-05T04:00:00Z","canceled":false,"ticketmaster_ids":["1B00522BCEF04D7F"],"buy_link":"http://ticketmaster.com/event/1B00522BCEF04D7F","on_sale_at":"2017-01-27T16:00:00Z","on_sale_date":"2017-01-27T16:00:00Z","local_start_time":"2017-05-04T19:00:00-05:00","on_sale_at_local":"2017-01-27T10:00:00-06:00","local_on_sale_date":"2017-01-27T10:00:00-06:00","created_at":"2017-01-24T14:45:16Z","updated_at":"2017-01-27T18:47:41Z","url_slug":"640760-may-4-2017-big-chief-package-2nd-weekend-n-o-jazz-heritage-festival","images":[],"ln_promoted":false,"megaticket":false,"event_type":"Festival - Music","is_external_buy_link":false,"tips":false,"venue":{"id":"ven_15056","name":"New Orleans Fairgrounds","lat":"29.9841","lng":"-90.081174","homepage":"http://www.fairgroundsracecourse.com/","address":{"street":"1751 Gentilly Boulevard","street2":null,"city":"New Orleans","state":"Louisiana","postal_code":"70116","country":"United States"},"phone":"5049445515","ticketmaster_ids":["221679"],"time_zone":"America/Chicago","time_zone_abbr":"CST","url_slug":"new-orleans-fairgrounds","vdp_img_url":null,"owned_by_ln":false,"websites":[],"terrapass":false,"box_office":{"parking_info":"Very limited","misc_info":"FESTIVAL IS RAIN OR SHINE","rules":{"child_rules":"CHILDREN (ages 2 - 10)$5.00 at the gate only.","general_rules":"All persons, belongings and vehicles will be subject to search.OTHER JAZZ FEST PROHIBITIONS APPLY.No video or recording equipment.No weapons, illicit drugs, or other contraband.No unauthorized vending.No outside beverages allowed whether carried or in vehicles. "}}},"lineup":[{"id":"art_167068","name":"New Orleans Jazz and Heritage Festival 2017","images":[{"tap":{"url":"https://media.livenation.com/artists/167068/167068-tap-147294.jpg?1485269116"}}],"ticketmaster_ids":["1100440"],"bio":null,"url_slug":"new-orleans-jazz-and-heritage-festival-2017","event_group":true,"headliner":false},{"id":"art_160750","name":"Dave Matthews and Tim Reynolds","images":[],"ticketmaster_ids":["855716"],"bio":null,"url_slug":"dave-matthews-and-tim-reynolds","event_group":false,"headliner":false},{"id":"art_41448","name":"Stevie Wonder","images":[{"show":{"url":"https://media.livenation.com/artists/41448/41448-show-96053.jpg?1410469739"}},{"tap":{"url":"https://media.livenation.com/artists/41448/41448-tap-70185.jpg?1374698558"}}],"ticketmaster_ids":["2161519","772848"],"bio":null,"url_slug":"stevie-wonder","event_group":false,"headliner":false},{"id":"art_56261","name":"Widespread Panic","images":[{"tap":{"url":"https://media.livenation.com/artists/56261/56261-tap-68303.jpg?1374694628"}}],"ticketmaster_ids":["2119654","2117214","2117212","2108811","2099491","736451","862325"],"bio":null,"url_slug":"widespread-panic","event_group":false,"headliner":false},{"id":"art_81106","name":"Kings of Leon","images":[{"tap":{"url":"https://media.livenation.com/artists/81106/81106-tap-94037.jpg?1386869168"}},{"tap":{"url":"https://media.livenation.com/artists/81106/81106-tap-94038.jpg?1386869881"}},{"homepage":{"url":"https://media.livenation.com/artists/81106/81106-homepage-147825.jpg?1485781352"}},{"show":{"url":"https://media.livenation.com/artists/81106/81106-show-147826.jpg?1485781373"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/81106/81106-bandpage-74284-size640.jpg?1476936100"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/81106/81106-bandpage-74284-size640.jpg?1476936100"}}],"ticketmaster_ids":["862453"],"bio":null,"url_slug":"kings-of-leon","event_group":false,"headliner":false},{"id":"art_42660","name":"Darius Rucker","images":[{"tap":{"url":"https://media.livenation.com/artists/42660/42660-tap-69569.jpg?1374697394"}},{"homepage":{"url":"https://media.livenation.com/artists/42660/42660-homepage-130088.jpg?1462402665"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/42660/42660-bandpage-74214-size640.jpg?1464730058"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/42660/42660-bandpage-74214-size640.jpg?1464730058"}}],"ticketmaster_ids":["2202068","2119588","2119593","2119589","2109854","2100255","2098270","829195","1612626"],"bio":null,"url_slug":"darius-rucker","event_group":false,"headliner":false},{"id":"art_41987","name":"Snoop Dogg","images":[{"tap":{"url":"https://media.livenation.com/artists/41987/41987-tap-69882.jpg?1374697993"}},{"thumb":{"url":"https://media.livenation.com/artists/41987/41987-thumb-64726.jpg?1353091019"}},{"hero":{"url":"https://media.livenation.com/artists/41987/41987-hero-64849.jpg?1353091020"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/41987/41987-bandpage-32669-size640.jpg?1386451117"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/41987/41987-bandpage-32669-size640.jpg?1386451117"}}],"ticketmaster_ids":["2242995","2216861","2014417","2189801","763942"],"bio":null,"url_slug":"snoop-dogg","event_group":false,"headliner":false},{"id":"art_44661","name":"Trombone Shorty & Orleans Avenue","images":[{"tap":{"url":"https://media.livenation.com/artists/44661/44661-tap-68207.jpg?1374694442"}}],"ticketmaster_ids":["2183893","1151950","1910294"],"bio":null,"url_slug":"trombone-shorty-orleans-avenue","event_group":false,"headliner":false},{"id":"art_157971","name":"Corinne Bailey Rae","images":[],"ticketmaster_ids":["1020843"],"bio":null,"url_slug":"corinne-bailey-rae","event_group":false,"headliner":false},{"id":"art_42037","name":"Wilco","images":[{"tap":{"url":"https://media.livenation.com/artists/42037/42037-tap-69842.jpg?1374697916"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/42037/42037-bandpage-32744-size640.jpg?1386451232"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/42037/42037-bandpage-32744-size640.jpg?1386451232"}}],"ticketmaster_ids":["773505"],"bio":null,"url_slug":"wilco","event_group":false,"headliner":false},{"id":"art_42210","name":"Patti LaBelle","images":[{"tap":{"url":"https://media.livenation.com/artists/42210/42210-tap-69751.jpg?1374697745"}}],"ticketmaster_ids":["735480"],"bio":null,"url_slug":"patti-labelle","event_group":false,"headliner":false},{"id":"art_41815","name":"Tower of Power","images":[{"tap":{"url":"https://media.livenation.com/artists/41815/41815-tap-69947.jpg?1374698121"}}],"ticketmaster_ids":["736323"],"bio":null,"url_slug":"tower-of-power","event_group":false,"headliner":false},{"id":"art_58110","name":"Rhiannon Giddens","images":[{"homepage":{"url":"https://media.livenation.com/artists/58110/58110-homepage-106802.jpg?1423264230"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/58110/58110-bandpage-74090-size640.jpg?1423265027"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/58110/58110-bandpage-74090-size640.jpg?1423265027"}}],"ticketmaster_ids":["2129570","1906351"],"bio":null,"url_slug":"rhiannon-giddens","event_group":false,"headliner":false},{"id":"art_131964","name":"Meghan Trainor","images":[{"show":{"url":"https://media.livenation.com/artists/131964/131964-show-129704.jpg?1461159512"}},{"homepage":{"url":"https://media.livenation.com/artists/131964/131964-homepage-129916.jpg?1461956792"}},{"mobile_detail":{"url":"https://media.livenation.com/mobile_images/artists/131964/131964-bandpage-74018-size640.jpg?1415037381"}},{"band_page_640":{"url":"https://media.livenation.com/mobile_images/artists/131964/131964-bandpage-74018-size640.jpg?1415037381"}}],"ticketmaster_ids":["2245246","2025699"],"bio":null,"url_slug":"meghan-trainor","event_group":false,"headliner":false},{"id":"art_140007","name":"The Meters","images":[{"":{"url":"/images/original/missing.png"}}],"ticketmaster_ids":[],"bio":null,"url_slug":"the-meters","event_group":false,"headliner":false}],"ticket_offerings":[{"bc_id":905129,"show_on_web":true,"on_sale_at":"2017-01-27T16:00:00Z","removed_on":null,"name":"Big Chief Package 2nd Weekend - N.O. Jazz & Heritage Festival","purchase_url":"http://ticketmaster.com/event/1B00522BCEF04D7F","source":"tap","type":"general","type_description":"This is the general offering for an event.  This type of offering does not grant any special VIP or premium access.  It includes but is not limited to General Admission access.","availability":"unknown","availability_description":null,"bc_event_id":877136,"presales":[],"ticket_promoter":{"created_at":"2017-01-24T14:45:17Z","id":182760,"promoter_bc_id":3,"promoter_name":"PROMOTED BY VENUE","ticket_offering_bc_id":905129,"updated_at":"2017-01-24T14:45:17Z"}}]}]}';   
    }
    
}